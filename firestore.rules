rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles (for search)
      allow read: if request.auth != null;
      // Only the user themselves can write their own profile
      allow write: if request.auth != null && request.auth.uid == userId;

      // Friends subcollection
      match /friends/{friendId} {
        // Only the user can read/write their own friends list
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Conversations collection
    match /conversations/{conversationId} {
      // Only participants can read the conversation
      allow read: if request.auth != null
                  && request.auth.uid in resource.data.participants;
      // Only participants can update the conversation (e.g. lastMessage)
      allow update: if request.auth != null
                    && request.auth.uid in resource.data.participants;
      // Authenticated users can create conversations (they must be a participant)
      allow create: if request.auth != null
                    && request.auth.uid in request.resource.data.participants;

      // Messages subcollection
      match /messages/{messageId} {
        // Only conversation participants can read messages
        allow read: if request.auth != null
                    && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        // Only conversation participants can send messages
        allow create: if request.auth != null
                      && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants
                      && request.resource.data.senderId == request.auth.uid;
        // Allow updating read status
        allow update: if request.auth != null
                      && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      }
    }

    // Friend requests collection
    match /friendRequests/{requestId} {
      // Sender and receiver can read their own requests
      allow read: if request.auth != null
                  && (request.auth.uid == resource.data.fromId
                      || request.auth.uid == resource.data.toId);
      // Authenticated users can create friend requests (must be the sender)
      allow create: if request.auth != null
                    && request.resource.data.fromId == request.auth.uid;
      // Receiver can update (accept) the request
      allow update: if request.auth != null
                    && request.auth.uid == resource.data.toId;
      // Either party can delete (reject/cancel) the request
      allow delete: if request.auth != null
                    && (request.auth.uid == resource.data.fromId
                        || request.auth.uid == resource.data.toId);
    }
  }
}
